---
title: 'Metadata Upload Tutorial Part 2: Associations'
author: "Kimberly Huynh"
date: "4/30/2019"
output: html_document
---

# Section 1: Overview

The objective of this tutorial is to demonstrate how to associate metadata that you have added to the traits database. 

This tutorial should be completed after `Metadata Upload Tutorial Part 1: Additions`.

For this tutorial, make sure that you have a local instance of a test database running and that all new experiments, sites, treatments, cultivars, and citations have been added.

## Notes on Running this Rmd

Knitting this markdown file will not associate any data in the test database. Being able to knit this file means that you will be able to successfully associate experiments with sites, experiments with treatments, sites with cultivars, and citations with sites.

To make associations in the test database, you will need to make an edit to this markdown file. 

`commit = TRUE` needs to be set in calls to `associateRow`.

When you are done testing, change the value of commit from `FALSE` to `TRUE` in the following chunk:

```{r commit-param}

commit <- FALSE

```

Note: Errors will occur if you try to associate your metadata more than once. If you would like to refresh the test database, re-run step 3 of the `How to set up local instance of BETY test database` tutorial.

# Section 2: Required input

URL to a public published google sheet 

_this should be the same URL that you used for the `Metadata Upload Tutorial Part 1: Addition` tutorial_

# Section 3: Metadata association

## Set up

Please provide the URL to your google sheet below. 

A sample URL has been provided for a google sheet containing MAC season 8 metadata. Replace the sample URL with your own.

```{r url}

url <- 'https://docs.google.com/spreadsheets/d/1c_5j7q3TO6gQ24KSopE-_LXA5HhfsUEqMupckGZAbo8/edit#gid=0' 

```

The following packages will need to be loaded: RPostgres, readxl, dplyr, and googlesheets

```{r load-pack}

library(RPostgres)
library(readxl)
library(dplyr)
library(googlesheets)

```

Create database connection 

_make sure that you have the test database running and your new metadata has been added_

The port number should be the same as the one indicated in docker-compose.override.yml.

```{r create-dbcon}

# no password required 
dbcon <- dbConnect(RPostgres::Postgres(),
                   host = 'localhost',
                   user = 'bety',
                   port = 5433)

```

Functions to include in package

```{r pack-fx}

# preparedStatement
# uploads parameterized query to database
preparedStatement <- function(con, query, params) {
  stopifnot(
    class(con) == "PqConnection",
    is.character(query),
    length(query) == 1,
    is.list(params)
  )
  qry <- DBI::dbSendStatement(con, query)
  res <- DBI::dbBind(qry, params)
  on.exit(DBI::dbClearResult(res))
}

# getFields
# returns column names of row that have a value and is included in tbl_fields
getFields <- function(tbl_fields,
                      row){
  com_ind <- which(!is.na(row))
  com_fields <- names(row)[com_ind]
  com_tbl_fields <- tbl_fields[tbl_fields %in% com_fields]
  return(com_tbl_fields)
}

# getParams
# returns an unnamed list of parameter values for a row that is subsetted according to fields
getParams <- function(row,
                      fields){
  params <- unname(as.list(row[fields]))
  return(params)
}

# getPositParams
# returns something like '$1, $2, $3' to be used for parameterized queries; number of params depends on length of fields
getPositParams <- function(fields){
  posit_params <- sapply(1:length(fields),
                         function(x) paste0('$', x))
  return(posit_params)
}

# getStatement
# returns a parameterized insert statement 
getStatement <- function(dbcon,
                         tbl_name,
                         fields){
  posit_params <- sapply(1:length(fields),
                         function(x) paste0('$', x))
  statement <- glue::glue_sql("insert into {DBI::SQL(tbl_name)} 
                              ({DBI::SQL(paste(fields, collapse = ', '))}) 
                              values 
                              ({DBI::SQL(paste(posit_params, collapse = ', '))})",
                              .con = dbcon)
  return(statement)
}

# addRow
# uploads insert statement 
# to be used to add new experiments, sites, treatments, cultivars, and citations
addRow <- function(row,
                   dbcon,
                   tbl_name,
                   tbl_fields,
                   user_id = NULL, 
                   commit = FALSE){ #user_id only required for experiment upload
  fields <- getFields(tbl_fields,
                      row)
  params <- getParams(row,
                      fields)
  # extra addition needed to insert data into experiments 
  if(tbl_name == 'experiments'){
    fields <- append(fields, 'user_id')
    params <- append(params, as.double(user_id)) #need to create this in experiments chunk
  }
  statement <- getStatement(dbcon,
                            tbl_name,
                            fields)
  dbBegin(dbcon)            
  preparedStatement(dbcon,
                    statement,
                    params)
  ifelse(commit == TRUE, dbCommit(dbcon), dbRollback(dbcon))
}

# associateRow
# uploads insert statement
# to be used to associate experiments with sites, experiments with treatments, sites with cultivars, and sites with citations
associateRow <- function(tbl_name,
                         col_1,
                         col_2,
                         val_1,
                         val_2,
                         commit = FALSE){
    statement <- glue::glue_sql("insert into {DBI::SQL(tbl_name)} 
                                ({DBI::SQL(paste(c(col_1, col_2), collapse = ', '))}) 
                                values ($1, $2)",
                                .con = dbcon)
    params <- list(val_1, val_2)
    dbBegin(dbcon)
    preparedStatement(dbcon,
                      statement,
                      params)
    ifelse(commit == TRUE, dbCommit(dbcon), dbRollback(dbcon))                    
}

```

Read in the treatments, sites, and citations sheets. 

These sheets contain information about which metadata to associate.

```{r read-user-gs}

# get key from URL
key <- extract_key_from_url(url)

# register sheet 
gs_obj <- key %>% gs_key(lookup = FALSE)

# sites sheet
sites <- gs_obj %>% gs_read(ws = 'sites')

# treatments sheet
treatments <- gs_obj %>% gs_read(ws = 'treatments')

# citations sheet
citations <- gs_obj %>% gs_read(ws = 'citations')

```

## Associate data

Read in bety experiments, sites, cultivars, treatments, and citations tables. 

We will refer to these tables to get ids for experiments, sites, treatments, cultivars, and citations.

```{r read-bety-update}

bety_experiments <- tbl(dbcon, 'experiments') %>% collect()
bety_sites <- tbl(dbcon, 'sites') %>% collect()
bety_cultivars <- tbl(dbcon, 'cultivars') %>% collect()
bety_treatments <- tbl(dbcon, 'treatments') %>% collect()
bety_citations <- tbl(dbcon, 'citations') %>% collect()
bety_species <- tbl(dbcon, 'species') %>% collect()

```

### Step 1: Associate experiments with sites

```{r associate-exp-site}

# loop through new sites added
# filter for row with sitename
# get site id from sitename
# get experiment id from associated experiment name

new_site <- sites$sitename

for(site in new_site){
  row <- sites %>% filter(sitename == site)
  
  site_id <- bety_sites %>%
    filter(sitename == row$sitename) %>%
    select(id)
  
  exp_id <- bety_experiments %>%
    filter(name == row$experiment) %>%
    select(id)
  
  associateRow(tbl_name = 'experiments_sites',
               #commit = TRUE,
               col_1 = 'experiment_id',
               col_2 = 'site_id',
               val_1 = as.double(exp_id$id),
               val_2 = as.double(site_id$id))
}


```

### Step 2: Associate experiments with treatments

```{r associate-exp-treat}

# loop through new treatments added
# filter for row with treatment name
# get treatment id
# get vector of associated experiment name
# loop through vector of exp names
# get experiment id

new_treat <- treatments$name

for(treat in new_treat){
  row <- treatments %>% filter(name == treat)
  
  treat_id <- bety_treatments %>%
      filter(name == treat) %>%
      select(id)
  
  associate_exp <- strsplit(row$experiment, split = ', ')[[1]]
  
  for(exp in associate_exp){
    exp_id <- bety_experiments %>%
      filter(name == exp) %>%
      select(id)
    
    associateRow(tbl_name = 'experiments_treatments',
               #commit = TRUE, 
               col_1 = 'experiment_id',
               col_2 = 'treatment_id',
               val_1 = as.double(exp_id$id),
               val_2 = as.double(treat_id$id))
  }
}

```

## Step 3: Associate sites with cultivars

```{r associate-site-cultivar}

# loop through new sites added
# filter for row with sitename
# get site_id
# get associated cultivar_id (need specie_id for this)
for(site in new_site){
  row <- sites %>% filter(sitename == site)
   
  site_id <- bety_sites %>%
    filter(sitename == row$sitename) %>%
    select(id)
  
  spp_id <- bety_species %>%
    filter(scientificname == row$species) %>%
    select(id)
  
  cultivar_id <- bety_cultivars %>%
    filter(name == row$cultivar & specie_id == as.double(spp_id$id)) %>%
    select(id)
  
  associateRow(tbl_name = 'sites_cultivars',
               #commit = TRUE,
               col_1 = 'site_id',
               col_2 = 'cultivar_id',
               val_1 = as.double(site_id$id),
               val_2 = as.double(cultivar_id$id))
}


```

## Step 4: Associate citations with sites

```{r associate-citation-site}

# get citation id
citation_id <- bety_citations %>%
  filter(author == citations$author & year == citations$year & title == citations$title) %>%
  select(id)

# loop through new sites added
# filter for row with sitename
# get site id
# associate with above citation id

for(site in new_site){
  row <- sites %>% filter(sitename == site)
  
  site_id <- bety_sites %>%
    filter(sitename == row$sitename) %>%
    select(id)
  
  associateRow(tbl_name = 'citations_sites',
               #commit = TRUE,
               col_1 = 'citation_id',
               col_2 = 'site_id',
               val_1 = as.double(citation_id$id),
               val_2 = as.double(site_id$id))
  
}

```

Close database connection

```{r close-dbcon}

dbDisconnect(dbcon)

```
