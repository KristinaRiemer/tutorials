# Accessing trait data in R 

```{r chunk-options-setup, echo = FALSE}

options(width = 100)

```

## Objective: To be able to use the R traits package to query trait data

This vignette will demonstrate to users how to query TERRA REF trait data using the traits package. 
Users will be shown an example of how to query and visualize season 6 canopy height data as well as how to find more information on a season, such as available traits and dates.

## Getting Started

First, you will need to install and load the traits package from github.

```{r traits-vig-pack, message = FALSE, results = FALSE}

devtools::install_github('terraref/traits', force = TRUE)
library(traits)

```

## How to query trait data

### Setting options

The function that you will be using to perform your queries is `betydb_query`.
Options can be set to reduce the number of arguments that need to be passed into the function.

```{r traits-vig-bety-opt}

options(betydb_url = "https://terraref.ncsa.illinois.edu/bety/",
        betydb_api_version = 'v1')

```

### An example: Season 6 canopy height data

The following is an example of how to query season 6 canopy height data. 

```{r traits-vig-canopy-query, message = FALSE}

canopy_height <- betydb_query(table     = "search", 
                              trait     = "canopy_height", 
                              sitename  = "~Season 6",
                              limit     =  "none")


```

### Time series of canopy height

Here is an example of how to visualize the data that we just queried. 

```{r traits-vig-canopy-plot, warning = FALSE, message = FALSE, results = FALSE}

#load in necessary packages
library(ggplot2)
library(lubridate)

#plot a time series of canopy height 
ggplot(data = canopy_height,
       aes(x = lubridate::yday(lubridate::ymd_hms(raw_date)), y = mean)) +
  geom_point(size = 0.5, position = position_jitter(width = 0.1)) +
  xlab("Day of Year") + ylab("Plant Height") +
  guides(color = guide_legend(title = 'Genotype')) +
  theme_bw()

```

## Season 6 Summary

The TERRA REF database contains other trait data for season 6.
Each trait was measured using a specific method. 
Here is a summary of available traits and their corresponding methods of measurement. 

```{r traits-vig-s6-all, message = FALSE, results = FALSE, echo = FALSE}

#load in dplyr package
library(dplyr)

#get all season 6 data 
season_6 <- betydb_query(table     = "search",
                         sitename  = "~Season 6",
                         limit     =  "none")
#get summary
season_6_summary <- season_6 %>% group_by(trait, method_name) %>% summarise(number_of_observations = n())

```

```{r traits-vig-s6-print, echo = FALSE, comment = ""}

print.data.frame(season_6_summary)

```

## How to query other seasons, traits, and dates

You can query other seasons and traits by changing the season number and trait name in the example query.
If you are interested in data for a specific date, you can add the `date` parameter to make your query more specific. 
If you are unsure of what traits or dates are available for a season, you can use the following R code as an example to get a subset of a season and figure out what specific dates and traits are available. 

```{r traits-vig-s4-example, results = FALSE, message = FALSE}

#get all of season 4 data 
season_4 <- betydb_query(table     = "search",
                         sitename  = "~Season 4",
                         limit     =  "none")

#get traits available for season 4 
traits <- unique(season_4$trait)

#filter for canopy_cover records
canopy_cover <- dplyr::filter(season_4, trait == 'canopy_cover') 

#get unique dates for canopy_cover records
canopy_cover_dates <- unique(canopy_cover$date)

```
