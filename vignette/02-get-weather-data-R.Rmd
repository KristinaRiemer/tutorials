---
title: "Get Weather Data"
output: html_document
---

# Objective: To be able to demonstrate how to get TERRA REF meteorological data

This vignette shows how to read weather data for the month of January 2017 from 
the [weather station](https://cals-mac.arizona.edu/weather-station) at the 
University of Arizona's [Maricopa Agricultural Center](http://cals-mac.arizona.edu/) 
into R. These data are stored online on the data management system Clowder, 
which is accessed using an API. Data across time for two of the weather 
variables, temperature and precipitation, are plotted in R. Lastly, how to get 
the list of all possible weather variables is demonstrated. 

### The Geostreams Database

![Schema](https://cloud.githubusercontent.com/assets/9286213/16991300/b2f2b09a-4e60-11e6-96b7-8b63c3d1f995.jpg)

#### Querying the API

The data can be accessed using a URL. You can find data for a particular station, 
a certain sensor from a station, or the datapoints from a sensor. Below are
the URLs for the UA-MAC AZMET weather station, a certain sensor at that station, 
and datapoints from that sensor for the month of January 2017. 

* Station: https://terraref.ncsa.illinois.edu/clowder/api/geostreams/sensors?sensor_name=UA-MAC+AZMET+Weather+Station
* Sensor: https://terraref.ncsa.illinois.edu/clowder/api/geostreams/sensors/438/streams
* Datapoints: https://terraref.ncsa.illinois.edu/clowder/api/geostreams/datapoints?stream_id=46431&since=2017-01-02&until=2017-01-31

All URLs have the same beginning (https://terraref.ncsa.illinois.edu/clowder/api/geostreams/), 
then additional information is added for each type of data as shown below. 

* Station: /sensors/sensor_name=[name]
* Sensor: /sensors/[sensor number]/streams
* Datapoints: /datapoints?stream_id=[datapoints number]&since=[start date]&until=[end date]

Possible sensor numbers for a station are found on the page for that station under
"id:", and then datapoints numbers are found on the sensor page under "stream_id:". 

The table belows lists the names of some stations that have available 
meteorological data and associated stream ids. 

| stream id | name                                     |
|------------|------------------------------------------|
| 3211        | UA-MAC AZMET Weather Station - weather  |
| 3212        | UA-MAC AZMET Weather Station - irrigation     |
| 46431        | UA-MAC AZMET Weather Station - weather (5 min)      |
| 3208        | EnvironmentLogger sensor_weather_station |
| 3207        | EnvironmentLogger sensor_par             |
| 748        | EnvironmentLogger sensor_spectrum        |
| 3210        | EnvironmentLogger sensor_co2             |
| 4806       | UIUC Energy Farm SE                      |
| 4807       | UIUC Energy Farm CEN                     |
| 4805       | UIUC Energy Farm NE                      |


Here is the json representation of a single five-minute observation:

```
[
   {
      "geometry":{
         "type":"Point",
         "coordinates":[
            33.0745666667,
            -111.9750833333,
            0
         ]
      },
      "start_time":"2016-08-30T00:06:24-07:00",
      "type":"Feature",
      "end_time":"2016-08-30T00:10:00-07:00",
      "properties":{
         "precipitation_rate":0.0,
         "wind_speed":1.6207870370370374,
         "surface_downwelling_shortwave_flux_in_air":0.0,
         "northward_wind":0.07488770951583902,
         "relative_humidity":26.18560185185185,
         "air_temperature":300.17606481481516,
         "eastward_wind":1.571286062845733,
         "surface_downwelling_photosynthetic_photon_flux_in_air":0.0
      }
   },
```


### Querying weather sensor data stream

The data represent 5 minute summaries aggregated from 1/s observations.

#### Using Curl

First, below is what the API looks like as a URL. Try pasting it into your browser.

https://terraref.ncsa.illinois.edu/clowder/api/geostreams/datapoints?stream_id=46431&since=2017-01-02&until=2017-01-31

These data are for one stream within a chosen time period. They can be 
automatically downloaded into a file on your computer by typing the following
into the command line. This uses the URL from above and the new file is named
spectra.json.

```{sh eval=FALSE}
curl -o spectra.json -X GET https://terraref.ncsa.illinois.edu/clowder/api/geostreams/datapoints?stream_id=46431&since=2017-01-02&until=2017-01-31
```

#### Using R

The following code sets the defaults for showing R code. 
```{r met-setup}
knitr::opts_chunk$set(cache = TRUE, message = FALSE)
```

And this is how you can access the same data in R. This uses the jsonlite R package 
and desired URL to pull the data in. The data is in a dataframe with two nested
dataframes, called `properties` and `geometries`. 

```{r met-geostream}
library(dplyr)
library(ggplot2)
library(jsonlite)
library(lubridate)

weather_all <- fromJSON('https://terraref.ncsa.illinois.edu/clowder/api/geostreams/datapoints?stream_id=46431&since=2017-01-02&until=2017-01-31', flatten = FALSE)
```

The `geometries` dataframe is then pulled out from these data, which contains
the datapoints from this stream. This is combined with a transformed version of the
end of the time period from the stream. 

```{r met-datapoints}
weather_data <- weather_all$properties %>% 
  mutate(time = ymd_hms(weather_all$end_time))
```

## Weather Plots

#### Wind Speed

Create a time series plot of one of the eight variables in the newly created dataframe. 

```{r weather}
theme_set(ggthemes::theme_few())
ggplot(data = weather_data) +
  geom_point(aes(x = time, y = wind_speed), size = 0.1)
```

#### Rainfall

A time series plot of another one of the variables. 

```{r precipitation}
ggplot(data = weather_data) +
  geom_point(aes(x = time, y = precipitation_rate), size = 0.1)
```
